{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "nixpacksPlan": {
      "phases": {
        "setup": {
          "nixPkgs": [
            "python3",
            "gcc",
            "cairo",
            "pango",
            "gdk-pixbuf",
            "glib",
            "gobject-introspection",
            "harfbuzz",
            "fontconfig",
            "freetype",
            "libffi"
          ]
        },
        "install": {
          "cmds": [
            "python -m venv --copies /opt/venv",
            ". /opt/venv/bin/activate && pip install --upgrade pip setuptools wheel",
            ". /opt/venv/bin/activate && pip install -r requirements.txt",
            "echo '=== Setting up WeasyPrint libraries ==='",
            "mkdir -p /usr/lib/x86_64-linux-gnu",
            "for lib in $(find /nix/store -name 'libgobject-2.0.so.0' 2>/dev/null); do cp -f $lib /usr/lib/x86_64-linux-gnu/libgobject-2.0.so.0 && echo \"Copied libgobject\"; done",
            "for lib in $(find /nix/store -name 'libglib-2.0.so.0' 2>/dev/null); do cp -f $lib /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0 && echo \"Copied libglib\"; done",
            "for lib in $(find /nix/store -name 'libcairo.so.2' 2>/dev/null); do cp -f $lib /usr/lib/x86_64-linux-gnu/libcairo.so.2 && echo \"Copied libcairo\"; done",
            "for lib in $(find /nix/store -name 'libpango-1.0.so.0' 2>/dev/null); do cp -f $lib /usr/lib/x86_64-linux-gnu/libpango-1.0.so.0 && echo \"Copied libpango\"; done",
            "for lib in $(find /nix/store -name 'libpangocairo-1.0.so.0' 2>/dev/null); do cp -f $lib /usr/lib/x86_64-linux-gnu/libpangocairo-1.0.so.0 && echo \"Copied libpangocairo\"; done",
            "for lib in $(find /nix/store -name 'libgdk_pixbuf-2.0.so.0' 2>/dev/null); do cp -f $lib /usr/lib/x86_64-linux-gnu/libgdk_pixbuf-2.0.so.0 && echo \"Copied libgdk_pixbuf\"; done",
            "ldconfig || true",
            "echo '=== Testing WeasyPrint import ==='",
            ". /opt/venv/bin/activate && python -c 'import weasyprint; print(\"WeasyPrint imported successfully!\")' || echo 'WeasyPrint import failed'"
          ]
        }
      },
      "start": {
        "cmd": ". /opt/venv/bin/activate && LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/nix/var/nix/profiles/default/lib:$LD_LIBRARY_PATH python -m uvicorn main:app --host 0.0.0.0 --port $PORT"
      }
    }
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
